<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Gestión de Categorías</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>

<header>
    <h1>BlockFile</h1>
    <a class="btn" href="{% url 'users:perfil_admin' %}">Perfil</a>
    <a class="btn" href="{% url 'gestorProductos:gestion' %}">Inventario</a>
    <a class="btn" href="{% url 'gestorCategorias:gestion' %}">Categorias</a>
    <a class="btn" href="{% url 'gestorUsuario:gestion' %}">Usuarios</a>
</header>
<h1>Gestión de Categorías</h1>

<!-- Buscador + Agregar -->
<form id="formBuscar" method="get" action="">
    <span>Buscar por:</span>
    <input type="text" name="id" placeholder="ID" value="{{ filtros.id }}">
    <input type="text" name="nombre" placeholder="Nombre" value="{{ filtros.nombre }}">
    <input type="text" name="descripcion" placeholder="Descripcion" value="{{ filtros.descripcion }}">
    <button type="submit">Buscar</button>
    <button type="button" id="btnAgregar">Agregar</button>
</form>

<!-- Tabla -->
<table border="1" cellpadding="6" cellspacing="0" style="margin-top:12px; width:100%; max-width:980px">
    <thead>
    <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Descripción</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="tblBody">
    {% for p in filas %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.descripcion }}</td>
            <td>
                <button type="button" onclick="abrirEditar({{ p.id }})">Editar</button>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="5">Sin resultados</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Paginador -->
<div id="pager" style="margin-top:10px;">
    <button type="button" onclick="irPagina(1)" {% if page == 1 %}disabled{% endif %}>&laquo; Primero</button>
    <button type="button" onclick="irPagina({{ page|add:-1 }})" {% if page <= 1 %}disabled{% endif %}>&lsaquo; Ant
    </button>
    <span>Página {{ page }} de {{ total_pages }}</span>
    <button type="button" onclick="irPagina({{ page|add:1 }})" {% if page >= total_pages %}disabled{% endif %}>Sig
        &rsaquo;
    </button>
    <button type="button" onclick="irPagina({{ total_pages }})" {% if page >= total_pages %}disabled{% endif %}>Último
        &raquo;
    </button>
</div>

<!-- Modal simple con JS sin CSS (para migrar a Angular luego) -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div style="background:#fff; margin:40px auto; padding:16px; width:min(900px, 95%); max-height:85vh; overflow:auto;">
        <h3 id="modalTitulo">Categoría</h3>
        <form id="formCategoria">
            <input type="hidden" id="inpId" name="id"/>

            <fieldset>
                <legend>Campos no modificables</legend>
                <div>Fecha de subida: <span id="spFecha">—</span></div>
                <div>ID: <span id="spId">—</span></div>
            </fieldset>

            <fieldset style="margin-top:10px;">
                <legend>Campos editables</legend>
                <div>
                    <label>Nombre</label><br/>
                    <input type="text" id="inpNombre" name="nombre" maxlength="50" required/>
                </div>
                <div>
                    <label>Descripción</label><br/>
                    <textarea id="inpDescripcion" name="descripcion" rows="4"></textarea>
                </div>
            </fieldset>

            <div style="display:flex; gap:8px; margin-top:12px;">
                <button type="button" id="btnAceptar">Aceptar</button>
                <button type="button" id="btnBorrar">Borrar</button>
                <button type="button" onclick="cerrarModal()">Cerrar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const CSRF_TOKEN = "{{ csrf_token }}";

    (() => {
        const $ = id => document.getElementById(id);
        const qs = s => document.querySelector(s);
        const show = el => el.style.display = 'block';
        const hide = el => el.style.display = 'none';

        // -------- Buscar / Listar --------
        const formBuscar = $('formBuscar');
        const tbody = $('tblBody');
        const pager = $('pager');
        const modal = $('modal');

        formBuscar.addEventListener('submit', e => {
            e.preventDefault();
            buscar(1);
        });

        const queryFromForm = () => {
            const q = new URLSearchParams(new FormData(formBuscar));
            // elimina campos vacíos
            [...q.keys()].forEach(k => {
                if (!q.get(k)?.trim()) q.delete(k);
            });
            return q;
        };

        async function buscar(page = 1) {
            const q = queryFromForm();
            q.set('page', page);
            try {
                const r = await fetch(`./api/listar/?${q}`);
                const resp = await r.json();
                if (!resp.ok) return alert('Error al listar');

                renderTabla(resp.rows);
                renderPaginador(resp.page, resp.total_pages);
            } catch {
                alert('No se pudo obtener la lista');
            }
        }

        function renderTabla(rows) {
            if (!rows?.length) {
                tbody.innerHTML = `<tr><td colspan="5">Sin resultados</td></tr>`;
                return;
            }
            tbody.innerHTML = rows.map(p => `
      <tr>
        <td>${p.id}</td>
        <td>${p.nombre}</td>
        <td>${p.descripcion || ''}</td>
        <td><button type="button" onclick="abrirEditar(${p.id})">Editar</button></td>
      </tr>
    `).join('');
        }

        function renderPaginador(page, total) {
            const b = (label, target, disabled) =>
                `<button type="button" onclick="irPagina(${target})" ${disabled ? 'disabled' : ''}>${label}</button>`;

            pager.innerHTML = [
                b('&laquo; Primero', 1, page <= 1),
                b('&lsaquo; Ant', page - 1, page <= 1),
                `<span>Página ${page} de ${total}</span>`,
                b('Sig &rsaquo;', page + 1, page >= total),
                b('Último &raquo;', total, page >= total)
            ].join('');
        }

        window.irPagina = p => buscar(Math.max(1, p));

        // -------- Modal: crear / editar --------
        const modalTitulo = $('modalTitulo');
        const inpId = $('inpId');
        const spId = $('spId');
        const spFecha = $('spFecha');
        const inpNombre = $('inpNombre');
        const inpDesc = $('inpDescripcion');

        function abrirModal() {
            show(modal);
        }

        window.cerrarModal = function cerrarModal() {
            hide(modal);
        }

        function resetForm() {
            modalTitulo.textContent = "Agregar categoría";
            inpId.value = "";
            spId.textContent = "—";
            spFecha.textContent = "—";
            inpNombre.value = "";
            inpDesc.value = "";
        }

        window.abrirEditar = async function abrirEditar(id) {
            try {
                const r = await fetch(`./api/detalle/${id}/`);
                const d = await r.json();
                modalTitulo.textContent = "Editar categoría";
                inpId.value = d.id;
                spId.textContent = d.id;
                spFecha.textContent = d.fecha?.slice(0, 19).replace('T', ' ') || '—';
                inpNombre.value = d.nombre || "";
                inpDesc.value = d.descripcion || "";
                abrirModal();
            } catch {
                alert('No se pudo cargar el detalle');
            }
        };

        $('btnAgregar').onclick = () => {
            resetForm();
            abrirModal();
        };

        // -------- Guardar / Borrar --------
        $('btnAceptar').onclick = async () => {
            const payload = {
                id: inpId.value || null,
                nombre: inpNombre.value,
                descripcion: inpDesc.value
            };
            try {
                const r = await fetch('./api/guardar/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
                    body: JSON.stringify(payload)
                });
                const resp = await r.json();
                if (!resp.ok) return alert('Error: ' + JSON.stringify(resp));

                alert('Guardado');
                if (!payload.id) {
                    // si se creó, abre el detalle recién creado
                    abrirEditar(resp.id);
                } else {
                    cerrarModal();
                    location.reload();
                }
            } catch {
                alert('No se pudo guardar');
            }
        };

        $('btnBorrar').onclick = async () => {
            const id = inpId.value;
            if (!id) {
                resetForm();
                return;
            }
            if (!confirm('¿Eliminar esta categoría?')) return;
            try {
                const r = await fetch(`./api/eliminar/${id}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': CSRF_TOKEN}
                });
                const resp = await r.json();
                if (resp.ok) {
                    alert('Eliminado');
                    cerrarModal();
                    location.reload();
                } else {
                    alert('No se pudo eliminar');
                }
            } catch {
                alert('No se pudo eliminar');
            }
        };
    })();
</script>
</body>
</html>
