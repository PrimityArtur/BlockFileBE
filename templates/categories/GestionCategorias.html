<!-- templates/categories/GestionCategorias.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Gestión de Categorías</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    {% load static %}
    <!-- Sistema CSS modular -->
    <link rel="stylesheet" href="{% static 'css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    <link rel="stylesheet" href="{% static 'css/components.css' %}">
    <link rel="stylesheet" href="{% static 'css/utilities.css' %}">
</head>
<body>

<header>
    <h1>BlockFile</h1>
    <nav>
        <a class="btn btn--ghost" href="{% url 'users:perfil_admin' %}">Perfil</a>
        <a class="btn btn--ghost" href="{% url 'gestorProductos:gestion' %}">Inventario</a>
        <a class="btn btn--ghost" href="{% url 'gestorCategorias:gestion' %}">Categorías</a>
        <a class="btn btn--ghost" href="{% url 'gestorUsuario:gestion' %}">Usuarios</a>
    </nav>
</header>

<main>
    <section class="container">
        <div class="between flex wrap items-end mb-4">
            <h1 class="mb-0">Gestión de Categorías</h1>
            <button type="button" class="btn" id="btnAgregar">Agregar</button>
        </div>

        <!-- Buscador -->
        <form id="formBuscar" method="get" action="" class="card p-4">
            <div class="form-row">
                <div>
                    <label for="f_id">ID</label>
                    <input id="f_id" type="text" name="id" placeholder="ID" value="{{ filtros.id }}">
                </div>
                <div>
                    <label for="f_nombre">Nombre</label>
                    <input id="f_nombre" type="text" name="nombre" placeholder="Nombre" value="{{ filtros.nombre }}">
                </div>
                <div>
                    <label for="f_descripcion">Descripción</label>
                    <input id="f_descripcion" type="text" name="descripcion" placeholder="Descripción"
                           value="{{ filtros.descripcion }}">
                </div>
                <div class="items-end" style="display:flex;">
                    <button type="submit" class="btn">Buscar</button>
                </div>
            </div>
        </form>

        <!-- Tabla -->
        <div class="card mt-4">
            <div class="max-w">
                <table aria-label="Listado de categorías">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th class="text-right">Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="tblBody">
                    {% for p in filas %}
                        <tr>
                            <td>{{ p.id }}</td>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.descripcion }}</td>
                            <td class="text-right">
                                <button type="button" class="btn" onclick="abrirEditar({{ p.id }})">Editar</button>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4">Sin resultados</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Paginador -->
        <div id="pager" class="mt-3"></div>

        <noscript>
            <div id="pager" class="mt-3">
                <button type="button" onclick="location.href='?page=1' " {% if page == 1 %}disabled{% endif %}>&laquo;
                    Primero
                </button>
                <button type="button" onclick="location.href='?page={{ page|add:-1 }}' "
                        {% if page <= 1 %}disabled{% endif %}>&lsaquo; Ant
                </button>
                <span>Página {{ page }} de {{ total_pages }}</span>
                <button type="button" onclick="location.href='?page={{ page|add:1 }}' "
                        {% if page >= total_pages %}disabled{% endif %}>Sig &rsaquo;
                </button>
                <button type="button" onclick="location.href='?page={{ total_pages }}' "
                        {% if page >= total_pages %}disabled{% endif %}>Último &raquo;
                </button>
            </div>
        </noscript>
    </section>
</main>

<!-- Modal (oculto por defecto; se muestra con .abierto) -->
<div id="modal" class="modal" aria-hidden="true" aria-labelledby="modalTitulo" role="dialog">
    <div class="modal__dialog" role="document">
        <div class="modal__header">
            <span id="modalTitulo" class="modal__title">Categoría</span>
            <button type="button" class="btn btn--ghost" id="btnCerrarX" aria-label="Cerrar">✕</button>
        </div>

        <form id="formCategoria" class="grid gap-4" novalidate>
            <input type="hidden" id="inpId" name="id"/>

            <fieldset class="border rounded p-3">
                <legend class="text-muted">Campos no modificables</legend>
                <div class="grid grid-2 gap-3">
                    <div>Fecha de subida: <span id="spFecha" class="text-muted">—</span></div>
                    <div>ID: <span id="spId" class="text-muted">—</span></div>
                </div>
            </fieldset>

            <fieldset class="border rounded p-3">
                <legend>Campos editables</legend>
                <div class="grid grid-2 gap-3">
                    <div style="grid-column: 1 / -1;">
                        <label for="inpNombre">Nombre</label>
                        <input type="text" id="inpNombre" name="nombre" maxlength="50" required/>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="inpDescripcion">Descripción</label>
                        <textarea id="inpDescripcion" name="descripcion" rows="4"></textarea>
                    </div>
                </div>
            </fieldset>

            <div class="modal__actions">
                <button type="button" class="btn" id="btnAceptar">Aceptar</button>
                <button type="button" class="btn btn--danger" id="btnBorrar">Borrar</button>
                <button type="button" class="btn btn--muted" id="btnCerrar">Cerrar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const CSRF_TOKEN = "{{ csrf_token }}";

    (() => {
        const $ = id => document.getElementById(id);
        const j = (url, opt = {}) => fetch(url, opt).then(r => r.json());

        // -------- Buscar / Listar --------
        const formBuscar = $('formBuscar');
        const tbody = $('tblBody');
        const pager = $('pager');
        const modal = $('modal');

        formBuscar.addEventListener('submit', e => {
            e.preventDefault();
            buscar(1);
        });

        const queryFromForm = () => {
            const q = new URLSearchParams(new FormData(formBuscar));
            [...q.keys()].forEach(k => {
                if (!q.get(k)?.trim()) q.delete(k);
            });
            return q;
        };

        async function buscar(page = 1) {
            const q = queryFromForm();
            q.set('page', page);
            try {
                const resp = await j(`./api/listar/?${q}`);
                if (!resp.ok) return alert('Error al listar');
                renderTabla(resp.rows || []);
                renderPaginador(resp.page || 1, resp.total_pages || 1);
            } catch {
                alert('No se pudo obtener la lista');
            }
        }

        function renderTabla(rows) {
            tbody.innerHTML = (rows && rows.length)
                ? rows.map(p => `
          <tr>
            <td>${p.id}</td>
            <td>${p.nombre}</td>
            <td>${p.descripcion || ''}</td>
            <td class="text-right"><button type="button" class="btn" onclick="abrirEditar(${p.id})">Editar</button></td>
          </tr>
        `).join('')
                : `<tr><td colspan="4">Sin resultados</td></tr>`;
        }

        function renderPaginador(page, total) {
            const b = (label, target, disabled) =>
                `<button type="button" onclick="irPagina(${target})" ${disabled ? 'disabled' : ''}>${label}</button>`;
            pager.innerHTML = [
                b('&laquo; Primero', 1, page <= 1),
                b('&lsaquo; Ant', page - 1, page <= 1),
                `<span>Página ${page} de ${total}</span>`,
                b('Sig &rsaquo;', page + 1, page >= total),
                b('Último &raquo;', total, page >= total)
            ].join('');
        }

        window.irPagina = p => buscar(Math.max(1, p));

        // -------- Modal (coherente con gestor de productos) --------
        const btnCerrar = $('btnCerrar');
        const btnCerrarX = $('btnCerrarX');

        function abrirModal() {
            modal.classList.add('abierto');
            modal.setAttribute('aria-hidden', 'false');
            setTimeout(() => $('inpNombre').focus(), 0);
        }

        function cerrarModal() {
            modal.classList.remove('abierto');
            modal.setAttribute('aria-hidden', 'true');
        }

        btnCerrar.addEventListener('click', cerrarModal);
        btnCerrarX.addEventListener('click', cerrarModal);
        modal.addEventListener('click', e => {
            if (e.target === modal) cerrarModal();
        });
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && modal.classList.contains('abierto')) cerrarModal();
        });

        // -------- Crear / Editar --------
        const modalTitulo = $('modalTitulo');
        const inpId = $('inpId');
        const spId = $('spId');
        const spFecha = $('spFecha');
        const inpNombre = $('inpNombre');
        const inpDesc = $('inpDescripcion');

        function resetForm() {
            modalTitulo.textContent = "Agregar categoría";
            inpId.value = "";
            spId.textContent = "—";
            spFecha.textContent = "—";
            inpNombre.value = "";
            inpDesc.value = "";
        }

        window.abrirEditar = async function abrirEditar(id) {
            try {
                const d = await j(`./api/detalle/${id}/`);
                modalTitulo.textContent = "Editar categoría";
                inpId.value = d.id || "";
                spId.textContent = d.id ?? "—";
                spFecha.textContent = d.fecha?.slice(0, 19).replace('T', ' ') || '—';
                inpNombre.value = d.nombre || "";
                inpDesc.value = d.descripcion || "";
                abrirModal();
            } catch {
                alert('No se pudo cargar el detalle');
            }
        };

        $('btnAgregar').addEventListener('click', () => {
            resetForm();
            abrirModal();
        });

        // -------- Guardar / Borrar --------
        $('btnAceptar').addEventListener('click', async () => {
            const payload = {id: inpId.value || null, nombre: inpNombre.value, descripcion: inpDesc.value};
            try {
                const resp = await j('./api/guardar/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) return alert('Error: ' + JSON.stringify(resp));
                alert('Guardado');
                if (!payload.id && resp.id) {
                    abrirEditar(resp.id); // creado -> abre en edición
                } else {
                    cerrarModal();
                    // refrescar manteniendo filtros/página
                    const u = new URL(window.location.href);
                    const page = Number(new URLSearchParams(u.search).get('page') || '1');
                    buscar(page);
                }
            } catch {
                alert('No se pudo guardar');
            }
        });

        $('btnBorrar').addEventListener('click', async () => {
            const id = inpId.value;
            if (!id) {
                resetForm();
                return;
            }
            if (!confirm('¿Eliminar esta categoría?')) return;
            try {
                const resp = await j(`./api/eliminar/${id}/`, {method: 'POST', headers: {'X-CSRFToken': CSRF_TOKEN}});
                if (resp.ok) {
                    alert('Eliminado');
                    cerrarModal();
                    const u = new URL(window.location.href);
                    const page = Number(new URLSearchParams(u.search).get('page') || '1');
                    buscar(page);
                } else {
                    alert('No se pudo eliminar');
                }
            } catch {
                alert('No se pudo eliminar');
            }
        });

        // Carga inicial
        document.addEventListener('DOMContentLoaded', () => {
            const sp = new URL(location.href).searchParams;
            buscar(parseInt(sp.get('page') || '1', 10));
        });
    })();
</script>
</body>
</html>
