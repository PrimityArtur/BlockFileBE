
<!-- templates/products/GestionProductos.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Gestión de Productos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<h1>Gestión de Productos</h1>

<!-- Buscador + Agregar -->
<form id="formBuscar" method="get" action="">
    <span>Buscar por:</span>
    <input type="text" name="id" placeholder="ID" value="{{ filtros.id }}">
    <input type="text" name="nombre" placeholder="Nombre" value="{{ filtros.nombre }}">
    <input type="text" name="autor" placeholder="Autor" value="{{ filtros.autor }}">
    <input type="text" name="categoria" placeholder="Categoría" value="{{ filtros.categoria }}">
    <button type="submit">Buscar</button>
    <button type="button" id="btnAgregar">Agregar</button>
</form>

<!-- Tabla -->
<table border="1" cellpadding="6" cellspacing="0" style="margin-top:12px; width:100%; max-width:980px">
    <thead>
    <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Autor</th>
        <th>Categoría</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="tblBody">
    {% for p in filas %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.autor }}</td>
            <td>{{ p.categoria }}</td>
            <td><button type="button" onclick="abrirEditar({{ p.id }})">Editar</button></td>
        </tr>
    {% empty %}
        <tr><td colspan="5">Sin resultados</td></tr>
    {% endfor %}
    </tbody>
</table>

<!-- Paginador -->
<div id="pager" style="margin-top:10px;">
    <button type="button" onclick="irPagina(1)" {% if page == 1 %}disabled{% endif %}>&laquo; Primero</button>
    <button type="button" onclick="irPagina({{ page|add:-1 }})" {% if page <= 1 %}disabled{% endif %}>&lsaquo; Ant</button>
    <span>Página {{ page }} de {{ total_pages }}</span>
    <button type="button" onclick="irPagina({{ page|add:1 }})" {% if page >= total_pages %}disabled{% endif %}>Sig &rsaquo;</button>
    <button type="button" onclick="irPagina({{ total_pages }})" {% if page >= total_pages %}disabled{% endif %}>Último &raquo;</button>
</div>

<!-- Modal simple con JS sin CSS (para migrar a Angular luego) -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div style="background:#fff; margin:40px auto; padding:16px; width:min(900px, 95%); max-height:85vh; overflow:auto;">
        <h3 id="modalTitulo">Producto</h3>
        <form id="formProducto">
            <input type="hidden" id="inpId" name="id" />

            <fieldset>
                <legend>Campos no modificables</legend>
                <div>Fecha de subida: <span id="spFecha">—</span></div>
                <div>Calificación (promedio): <span id="spCalif">—</span></div>
                <div>ID: <span id="spId">—</span></div>
            </fieldset>

            <fieldset style="margin-top:10px;">
                <legend>Campos editables</legend>
                <div>
                    <label>Nombre</label><br />
                    <input type="text" id="inpNombre" name="nombre" maxlength="50" required />
                </div>
                <div>
                    <label>Descripción</label><br />
                    <textarea id="inpDescripcion" name="descripcion" rows="4"></textarea>
                </div>
                <div>
                    <label>Versión</label><br />
                    <input type="text" id="inpVersion" name="version" maxlength="50" />
                </div>
                <div>
                    <label>Precio</label><br />
                    <input type="number" id="inpPrecio" name="precio" min="0" step="0.01" />
                </div>
                <div>
                    <label>Autor (id)</label><br />
                    <input type="number" id="inpAutor" name="id_autor" min="1" />
                </div>
                <div>
                    <label>Categoría (id)</label><br />
                    <input type="number" id="inpCategoria" name="id_categoria" min="1" />
                </div>
                <div>
                    <label>Activo</label>
                    <input type="checkbox" id="inpActivo" name="activo" checked />
                </div>
            </fieldset>

            <fieldset style="margin-top:10px;">
                <legend>Imágenes</legend>
                <input type="file" id="fileImagen" accept="image/*" />
                <button type="button" id="btnAgregarImagen">Agregar Imagen</button>
                <div id="listaImagenes" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:8px; margin-top:10px;"></div>
            </fieldset>

            <div style="display:flex; gap:8px; margin-top:12px;">
                <button type="button" id="btnAceptar">Aceptar</button>
                <button type="button" id="btnBorrar">Borrar</button>
                <button type="button" onclick="cerrarModal()">Cerrar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const CSRF_TOKEN = "{{ csrf_token }}";

    // --- Buscar sin recargar (AJAX) ---
    const formBuscar = document.getElementById('formBuscar');
    formBuscar.addEventListener('submit', (e) => {
        e.preventDefault();
        buscar(1);
    });

    function queryParamsFromForm() {
        const fd = new FormData(formBuscar);
        const q = new URLSearchParams();
        for (const [k, v] of fd.entries()) {
            if (v != null && String(v).trim() !== '') q.set(k, String(v).trim());
        }
        return q;
    }

    function buscar(page = 1) {
        const q = queryParamsFromForm();
        q.set('page', String(page));
        fetch(`./api/listar/?${q.toString()}`)
            .then(r => r.json())
            .then(resp => {
                if (!resp.ok) {
                    alert('Error al listar');
                    return;
                }
                renderTabla(resp.rows);
                renderPaginador(resp.page, resp.total_pages);
                // Actualiza la URL (opcional, útil para recargar con el mismo estado)
                const u = new URL(window.location.href);
                u.search = q.toString();
                window.history.replaceState(null, '', u.toString());
            })
            .catch(() => alert('No se pudo obtener la lista'));
    }

    function renderTabla(rows) {
        const tbody = document.getElementById('tblBody');
        tbody.innerHTML = '';
        if (!rows || rows.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5">Sin resultados</td>`;
            tbody.appendChild(tr);
            return;
        }
        for (const p of rows) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${p.id}</td>
        <td>${esc(p.nombre)}</td>
        <td>${esc(p.autor || '')}</td>
        <td>${esc(p.categoria || '')}</td>
        <td><button type="button" onclick="abrirEditar(${p.id})">Editar</button></td>
      `;
            tbody.appendChild(tr);
        }
    }

    function renderPaginador(page, total) {
        const pager = document.getElementById('pager');
        const disPrim = page <= 1 ? 'disabled' : '';
        const disAnt  = page <= 1 ? 'disabled' : '';
        const disSig  = page >= total ? 'disabled' : '';
        const disUlt  = page >= total ? 'disabled' : '';

        pager.innerHTML = `
      <button type="button" onclick="irPagina(1)" ${disPrim}>&laquo; Primero</button>
      <button type="button" onclick="irPagina(${page - 1})" ${disAnt}>&lsaquo; Ant</button>
      <span>Página ${page} de ${total}</span>
      <button type="button" onclick="irPagina(${page + 1})" ${disSig}>Sig &rsaquo;</button>
      <button type="button" onclick="irPagina(${total})" ${disUlt}>Último &raquo;</button>
    `;
    }

    // Utilidad simple contra XSS en textos
    function esc(s) {
        return String(s).replace(/[&<>"']/g, m => (
            { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]
        ));
    }

    function irPagina(p) {
        if (p < 1) p = 1;
        buscar(p);
    }

    document.getElementById('btnAgregar').addEventListener('click', () => {
        abrirModalCrear();
    });

    function abrirEditar(id) {
        fetch(`./api/detalle/${id}/`)
            .then(r => r.json())
            .then(d => {
                abrirModalConDatos(d);
            });
    }

    function abrirModalCrear() {
        document.getElementById('modalTitulo').textContent = "Agregar producto";
        document.getElementById('inpId').value = "";
        document.getElementById('spId').textContent = "—";
        document.getElementById('spFecha').textContent = "—";
        document.getElementById('spCalif').textContent = "—";
        document.getElementById('inpNombre').value = "";
        document.getElementById('inpDescripcion').value = "";
        document.getElementById('inpVersion').value = "";
        document.getElementById('inpPrecio').value = "";
        document.getElementById('inpAutor').value = "";
        document.getElementById('inpCategoria').value = "";
        document.getElementById('inpActivo').checked = true;
        document.getElementById('listaImagenes').innerHTML = "";
        abrirModal();
    }

    function abrirModalConDatos(d) {
        document.getElementById('modalTitulo').textContent = "Editar producto";
        document.getElementById('inpId').value = d.id;
        document.getElementById('spId').textContent = d.id;
        document.getElementById('spFecha').textContent = d.fecha?.slice(0,19).replace('T',' ') || '—';
        document.getElementById('spCalif').textContent = d.calificacion ?? '—';

        document.getElementById('inpNombre').value = d.nombre || "";
        document.getElementById('inpDescripcion').value = d.descripcion || "";
        document.getElementById('inpVersion').value = d.version || "";
        document.getElementById('inpPrecio').value = d.precio || "";
        document.getElementById('inpAutor').value = d.autor_id || "";
        document.getElementById('inpCategoria').value = d.categoria_id || "";
        document.getElementById('inpActivo').checked = !!d.activo;

        const cont = document.getElementById('listaImagenes');
        cont.innerHTML = "";
        (d.imagenes || []).forEach(img => {
            cont.appendChild(crearCardImagen(img));
        });

        abrirModal();
    }

    function abrirModal() {
        document.getElementById('modal').style.display = 'block';
    }
    function cerrarModal() {
        document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('btnAceptar').addEventListener('click', () => {
        const payload = {
            id: document.getElementById('inpId').value || null,
            nombre: document.getElementById('inpNombre').value,
            descripcion: document.getElementById('inpDescripcion').value,
            version: document.getElementById('inpVersion').value,
            precio: document.getElementById('inpPrecio').value,
            id_autor: document.getElementById('inpAutor').value || null,
            id_categoria: document.getElementById('inpCategoria').value || null,
            activo: document.getElementById('inpActivo').checked
        };
        fetch('./api/guardar/', {
            method:'POST',
            headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
            body: JSON.stringify(payload)
        }).then(r => r.json()).then(resp => {
            if(resp.ok){
                alert('Guardado');
                // si es creación, refrescar detalle para permitir imágenes
                if(!payload.id){
                    abrirEditar(resp.id);
                } else {
                    cerrarModal();
                    window.location.reload();
                }
            } else {
                alert('Error: ' + JSON.stringify(resp));
            }
        });
    });

    document.getElementById('btnBorrar').addEventListener('click', () => {
        const id = document.getElementById('inpId').value;
        if(!id){
            // limpiar formulario nuevo
            abrirModalCrear();
            return;
        }
        if(confirm('¿Eliminar este producto?')){
            fetch(`./api/eliminar/${id}/`, {method:'POST', headers:{'X-CSRFToken': CSRF_TOKEN}})
                .then(r => r.json()).then(resp => {
                if(resp.ok){ alert('Eliminado'); cerrarModal(); window.location.reload(); }
            });
        }
    });

    document.getElementById('btnAgregarImagen').addEventListener('click', () => {
        const id = document.getElementById('inpId').value;
        if(!id){ alert('Primero guarde el producto'); return; }
        const f = document.getElementById('fileImagen').files[0];
        if(!f){ alert('Seleccione una imagen'); return; }
        const form = new FormData();
        form.append('archivo', f);
        fetch(`./api/subir_imagen/${id}/`, {method:'POST', headers:{'X-CSRFToken': CSRF_TOKEN}, body: form})
            .then(r => r.json()).then(resp => {
            if(resp.ok){
                // añadir card con orden por defecto
                const cont = document.getElementById('listaImagenes');
                cont.appendChild(crearCardImagen({id: resp.id_imagen, orden: cont.children.length+1}, f));
                document.getElementById('fileImagen').value = '';
            }
        });
    });

    function crearCardImagen(img, fileBlob){
        const card = document.createElement('div');
        card.style.border = '1px solid #ccc';
        card.style.padding = '6px';

        const preview = document.createElement('img');
        preview.alt = 'img';
        preview.style.width = '100%';
        preview.style.maxHeight = '120px';
        preview.style.objectFit = 'cover';

        if(fileBlob){
            const reader = new FileReader();
            reader.onload = e => preview.src = e.target.result;
            reader.readAsDataURL(fileBlob);
        } else {
            // No tenemos endpoint para servir binario; dejamos placeholder
            preview.src = `./api/imagen/${img.id}/`;
            preview.alt = `Imagen #${img.id}`;
        }

        const row = document.createElement('div');
        row.style.display = 'flex'; row.style.gap = '6px'; row.style.alignItems='center'; row.style.marginTop='6px';

        const lbl = document.createElement('span');
        lbl.textContent = 'Número de orden:';
        const orden = document.createElement('input');
        orden.type = 'number'; orden.min = '1'; orden.value = img.orden || 1; orden.style.width='70px';

        const btnSet = document.createElement('button');
        btnSet.type = 'button'; btnSet.textContent = 'Actualizar orden';
        btnSet.onclick = () => {
            fetch(`./api/reordenar_imagen/${img.id}/`, {
                method:'POST',
                headers:{'X-CSRFToken': CSRF_TOKEN, 'Content-Type':'application/x-www-form-urlencoded'},
                body: 'orden=' + encodeURIComponent(orden.value)
            }).then(r => r.json()).then(resp => { if(resp.ok) alert('Orden actualizado'); });
        };

        const btnDel = document.createElement('button');
        btnDel.type = 'button'; btnDel.textContent = 'Borrar imagen';
        btnDel.onclick = () => {
            if(confirm('¿Borrar imagen?')){
                fetch(`./api/borrar_imagen/${img.id}/`, {method:'POST', headers:{'X-CSRFToken': CSRF_TOKEN}})
                    .then(r => r.json()).then(resp => {
                    if(resp.ok){ card.remove(); }
                });
            }
        }

        row.appendChild(lbl); row.appendChild(orden); row.appendChild(btnSet); row.appendChild(btnDel);
        card.appendChild(preview);
        card.appendChild(row);
        return card;
    }
</script>
</body>
</html>
