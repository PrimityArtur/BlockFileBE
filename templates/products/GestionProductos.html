<!-- templates/products/GestionProductos.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Gestión de Productos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
<header>
    <h1>BlockFile</h1>
    <a class="btn" href="{% url 'users:perfil_admin' %}">Perfil</a>
    <a class="btn" href="{% url 'gestorProductos:gestion' %}">Inventario</a>
    <a class="btn" href="{% url 'gestorCategorias:gestion' %}">Categorias</a>
    <a class="btn" href="{% url 'gestorUsuario:gestion' %}">Usuarios</a>
</header>

<h1>Gestión de Productos</h1>

<form id="formBuscar" method="get" action="">
    <span>Buscar por:</span>
    <input type="text" name="id" placeholder="ID" value="{{ filtros.id }}">
    <input type="text" name="nombre" placeholder="Nombre" value="{{ filtros.nombre }}">
    <input type="text" name="autor" placeholder="Autor" value="{{ filtros.autor }}">
    <input type="text" name="categoria" placeholder="Categoría" value="{{ filtros.categoria }}">
    <button type="submit">Buscar</button>
    <button type="button" id="btnAgregar">Agregar</button>
</form>

<!-- Tabla -->
<table border="1" cellpadding="6" cellspacing="0" style="margin-top:12px; width:100%; max-width:980px">
    <thead>
    <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Autor</th>
        <th>Categoría</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="tblBody">
    {% for p in filas %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.autor }}</td>
            <td>{{ p.categoria }}</td>
            <td>
                <button type="button" onclick="abrirEditar({{ p.id }})">Editar</button>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="5">Sin resultados</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Paginador -->
<div id="pager" style="margin-top:10px;">
    <button type="button" onclick="irPagina(1)" {% if page == 1 %}disabled{% endif %}>&laquo; Primero</button>
    <button type="button" onclick="irPagina({{ page|add:-1 }})" {% if page <= 1 %}disabled{% endif %}>&lsaquo; Ant
    </button>
    <span>Página {{ page }} de {{ total_pages }}</span>
    <button type="button" onclick="irPagina({{ page|add:1 }})" {% if page >= total_pages %}disabled{% endif %}>Sig
        &rsaquo;
    </button>
    <button type="button" onclick="irPagina({{ total_pages }})" {% if page >= total_pages %}disabled{% endif %}>Último
        &raquo;
    </button>
</div>

<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div style="background:#fff; margin:40px auto; padding:16px; width:min(900px, 95%); max-height:85vh; overflow:auto;">
        <h3 id="modalTitulo">Producto</h3>
        <form id="formProducto">
            <input type="hidden" id="inpId" name="id"/>

            <fieldset>
                <legend>Campos no modificables</legend>
                <div>Fecha de subida: <span id="spFecha">—</span></div>
                <div>Calificación (promedio): <span id="spCalif">—</span></div>
                <div>ID: <span id="spId">—</span></div>
            </fieldset>

            <fieldset style="margin-top:10px;">
                <legend>Campos editables</legend>
                <div>
                    <label>Nombre</label><br/>
                    <input type="text" id="inpNombre" name="nombre" maxlength="50" required/>
                </div>
                <div>
                    <label>Descripción</label><br/>
                    <textarea id="inpDescripcion" name="descripcion" rows="4"></textarea>
                </div>
                <div>
                    <label>Versión</label><br/>
                    <input type="text" id="inpVersion" name="version" maxlength="50"/>
                </div>
                <div>
                    <label>Precio</label><br/>
                    <input type="number" id="inpPrecio" name="precio" min="0" step="0.01"/>
                </div>
                <div>
                    <label>Autor (id)</label><br/>
                    <input type="number" id="inpAutor" name="id_autor" min="1"/>
                </div>
                <div>
                    <label>Categoría (id)</label><br/>
                    <input type="number" id="inpCategoria" name="id_categoria" min="1"/>
                </div>
                <div>
                    <label>Activo</label>
                    <input type="checkbox" id="inpActivo" name="activo" checked/>
                </div>
            </fieldset>

            <fieldset style="margin-top:10px;">
                <legend>Archivo del producto</legend>
                <div id="seccionArchivo">
                    <div>Estado: <span id="spArchivoEstado">—</span></div>
                    <a id="lnkArchivoDescarga" href="" target="_blank" style="display:none;">Descargar archivo</a>
                    <br>
                    <input type="file" id="fileProducto"/>
                    <button type="button" id="btnSubirArchivo">Subir/Reemplazar archivo</button>
                </div>
            </fieldset>

            <fieldset style="margin-top:10px;">
                <legend>Imágenes</legend>
                <input type="file" id="fileImagen" accept="image/*"/>
                <button type="button" id="btnAgregarImagen">Agregar Imagen</button>
                <div id="listaImagenes"
                     style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:8px; margin-top:10px;"></div>
            </fieldset>

            <div style="display:flex; gap:8px; margin-top:12px;">
                <button type="button" id="btnAceptar">Aceptar</button>
                <button type="button" id="btnBorrar">Borrar</button>
                <button type="button" onclick="cerrarModal()">Cerrar</button>
            </div>
        </form>
    </div>
</div>
<script>
    (() => {
        const $ = id => document.getElementById(id);
        const j = (url, opt = {}) => fetch(url, opt).then(r => r.json());
        const setVal = (id, v = '') => ($(id).value = v);
        const setTxt = (id, v = '—') => ($(id).textContent = (v ?? '—'));
        const CSRF = "{{ csrf_token }}";

        // ---- refs
        const formBuscar = $('formBuscar');
        const tblBody = $('tblBody');
        const pager = $('pager');
        const modal = $('modal');

        // ---- búsqueda + tabla + paginador
        const qFromForm = () => {
            const q = new URLSearchParams(new FormData(formBuscar));
            [...q].forEach(([k, v]) => {
                if (!String(v).trim()) q.delete(k);
            });
            return q;
        };

        async function buscar(page = 1) {
            const q = qFromForm();
            q.set('page', page);
            const resp = await j(`./api/listar/?${q}`);
            renderTabla(resp.rows || []);
            renderPager(resp.page || 1, resp.total_pages || 1);
        }


        function renderPager(p, t) {
            const btn = (txt, n, dis) =>
                `<button type="button" onclick="irPagina(${n})" ${dis ? 'disabled' : ''}>${txt}</button>`;
            pager.innerHTML = [
                btn('&laquo; Primero', 1, p <= 1),
                btn('&lsaquo; Ant', p - 1, p <= 1),
                `<span>Página ${p} de ${t}</span>`,
                btn('Sig &rsaquo;', p + 1, p >= t),
                btn('Último &raquo;', t, p >= t)
            ].join('');
        }

        function renderTabla(rows) {
            tblBody.innerHTML = rows.length ? rows.map(p => `
            <tr>
                <td>${p.id}</td>
                <td>${p.nombre}</td>
                <td>${p.autor || ''}</td>
                <td>${p.categoria || ''}</td>
                <td><button type="button" data-editar="${p.id}">Editar</button></td>
            </tr>
            `).join('') : `<tr><td colspan="5">Sin resultados</td></tr>`;
        }

        window.irPagina = p => buscar(Math.max(1, p));
        formBuscar.onsubmit = e => {
            e.preventDefault();
            buscar(1);
        };

        // click en “Editar” dentro de la tabla (delegación)
        tblBody.onclick = async e => {
            const id = e.target?.dataset?.editar;
            if (!id) return;
            abrirCon(await j(`./api/detalle/${id}/`));
        };

        // ---- modal (crear/editar)
        const fillStatic = d => {
            setTxt('spId', d?.id);
            setTxt('spFecha', d?.fecha?.slice(0, 19).replace('T', ' ') || '—');
            setTxt('spCalif', d?.calificacion ?? '—');
        };
        const fillForm = d => {
            setVal('inpId', d?.id || '');
            setVal('inpNombre', d?.nombre || '');
            setVal('inpDescripcion', d?.descripcion || '');
            setVal('inpVersion', d?.version || '');
            setVal('inpPrecio', d?.precio || '');
            setVal('inpAutor', d?.autor_id || '');
            setVal('inpCategoria', d?.categoria_id || '');
            $('inpActivo').checked = !!d?.activo || d?.activo === undefined; // nuevo => true
        };

        function abrirCrear() {
            $('modalTitulo').textContent = 'Agregar producto';
            fillStatic({});
            fillForm({});
            $('listaImagenes').innerHTML = '';
            $('lnkArchivoDescarga').style.display = 'none';
            modal.style.display = 'block';
        }

        $('btnAgregar').onclick = abrirCrear;

        function abrirCon(d) {
            $('modalTitulo').textContent = 'Editar producto';
            fillStatic(d);
            fillForm(d);

            // archivo
            if (d?.tiene_archivo) {
                setTxt('spArchivoEstado', 'Cargado');
                const base = "{% url 'gestorProductos:descargar_archivo_producto' 0 %}".replace("0/", "");
                const link = $('lnkArchivoDescarga');
                link.href = `${base}${d.id}/`;
                link.style.display = 'inline';
            } else {
                setTxt('spArchivoEstado', 'Sin archivo');
                $('lnkArchivoDescarga').style.display = 'none';
            }

            // imágenes
            const cont = $('listaImagenes');
            cont.innerHTML = '';
            (d?.imagenes || []).forEach(img => cont.appendChild(cardImagen(img)));

            modal.style.display = 'block';
        }

        window.cerrarModal = () => modal.style.display = 'none';

        // ---- acciones: guardar / borrar / subir archivo / agregar imagen
        $('btnAceptar').onclick = async () => {
            const payload = {
                id: $('inpId').value || null,
                nombre: $('inpNombre').value,
                descripcion: $('inpDescripcion').value,
                version: $('inpVersion').value,
                precio: $('inpPrecio').value,
                id_autor: $('inpAutor').value || null,
                id_categoria: $('inpCategoria').value || null,
                activo: $('inpActivo').checked
            };
            const resp = await j('./api/guardar/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
                body: JSON.stringify(payload)
            });
            if (!payload.id && resp.id) abrirEditar(resp.id);
            else {
                cerrarModal();
                location.reload();
            }
        };

        $('btnBorrar').onclick = async () => {
            const id = $('inpId').value;
            if (!id) return abrirCrear();
            if (!confirm('¿Eliminar este producto?')) return;
            const resp = await j(`./api/eliminar/${id}/`, {method: 'POST', headers: {'X-CSRFToken': CSRF}});
            if (resp.ok) {
                cerrarModal();
                location.reload();
            }
        };

        $('btnSubirArchivo').onclick = async () => {
            const id = $('inpId').value, f = $('fileProducto').files[0];
            if (!id || !f) return;
            const form = new FormData();
            form.append('archivo', f);
            const base = "{% url 'gestorProductos:api_subir_archivo_producto' 0 %}".replace("0/", "");
            const resp = await j(`${base}${id}/`, {method: 'POST', headers: {'X-CSRFToken': CSRF}, body: form});
            if (resp.ok) {
                setTxt('spArchivoEstado', 'Cargado');
                $('fileProducto').value = '';
            }
        };

        $('btnAgregarImagen').onclick = async () => {
            const id = $('inpId').value, f = $('fileImagen').files[0];
            if (!id || !f) return;
            const form = new FormData();
            form.append('archivo', f);
            const resp = await j(`./api/subir_imagen/${id}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': CSRF},
                body: form
            });
            if (!resp.ok) return;
            $('listaImagenes').appendChild(cardImagen({
                id: resp.id_imagen,
                orden: $('listaImagenes').children.length + 1
            }, f));
            $('fileImagen').value = '';
        };

        // ---- tarjetas de imagen (preview, reordenar, borrar)
        function cardImagen(img, fileBlob) {
            const card = document.createElement('div');

            const preview = document.createElement('img');
            preview.alt = 'img';
            preview.style.width = '100%';
            preview.style.maxHeight = '120px';
            preview.style.objectFit = 'cover';
            if (fileBlob) {
                const rd = new FileReader();
                rd.onload = e => preview.src = e.target.result;
                rd.readAsDataURL(fileBlob);
            } else {
                preview.src = `./api/imagen/${img.id}/`;
                preview.alt = `Imagen #${img.id}`;
            }

            const orden = document.createElement('input');
            orden.type = 'number';
            orden.min = '1';
            orden.value = img.orden || 1;
            orden.style.width = '70px';

            const btnSet = document.createElement('button');
            btnSet.type = 'button';
            btnSet.textContent = 'Actualizar orden';
            btnSet.onclick = () => j(`./api/reordenar_imagen/${img.id}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': CSRF, 'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'orden=' + encodeURIComponent(orden.value)
            });

            const btnDel = document.createElement('button');
            btnDel.type = 'button';
            btnDel.textContent = 'Borrar imagen';
            btnDel.onclick = async () => {
                if (!confirm('¿Borrar imagen?')) return;
                const r = await j(`./api/borrar_imagen/${img.id}/`, {method: 'POST', headers: {'X-CSRFToken': CSRF}});
                if (r.ok) card.remove();
            };

            const row = document.createElement('div');
            row.append('Número de orden:', orden, btnSet, btnDel);

            card.append(preview, row);
            return card;
        }

        // ---- helpers globales usados por otros handlers
        window.abrirEditar = async id => abrirCon(await j(`./api/detalle/${id}/`));

        // ---- carga inicial (si hay parámetros en la URL)
        document.addEventListener('DOMContentLoaded', () => {
            const sp = new URL(location.href).searchParams;
            buscar(parseInt(sp.get('page') || '1', 10));
        });
    })();
</script>

</body>
</html>
