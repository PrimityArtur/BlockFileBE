<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Catálogo</title>
</head>
<body>
<header>
    <H1>BlockFile</H1>
    <a class="btn" href="{% url 'catalogoProductos:catalogo' %}">Inicio</a>
    <a class="btn" href="{% url 'Rankings:rankings' %}">Ranking</a>
    <a class="btn" href="{% url 'PerfilCliente:PerfilCliente' %}">Perfil</a>
    <a class="btn" href="{% url 'users:logout' %}">Cerrar Sesión</a>
</header>

<form id="formBuscar" method="get" action="">
    <span>Buscar por:</span>
    <input type="text" name="nombre" placeholder="Nombre" value="{{ filtros.nombre }}">
    <input type="text" name="autor" placeholder="Autor" value="{{ filtros.autor }}">
    <input type="text" name="categoria" placeholder="Categoría" value="{{ filtros.categoria }}">
    <button type="submit">Buscar</button>
</form>

<ul id="tblBody">
    {% for p in filas %}
        <li>
            {% if p.imagen_1_id %}
                <img src="{% url 'catalogoProductos:api_imagen' p.imagen_1_id %}" alt="Imagen de {{ p.nombre }}">
            {% else %}
                <span>Sin imagen</span>
            {% endif %}
            <div>Precio: {{ p.precio|default:"-" }}</div>
            <div>
                <a href="{% url 'vistaProducto:detalle_producto' p.id %}">
                    <strong>{{ p.nombre }}</strong>
                </a>
            </div>
            <div>Autor: {{ p.autor|default:"-" }}</div>
            <div>Calificación: {{ p.calificacion_promedio|default:"-" }}</div>
            <div>{{ p.compras }} compras</div>
        </li>
    {% empty %}
        Sin resultados
    {% endfor %}
</ul>

<!-- Paginador -->
<div id="pager" style="margin-top:10px;">
    <button type="button" onclick="irPagina(1)" {% if page == 1 %}disabled{% endif %}>&laquo; Primero</button>
    <button type="button" onclick="irPagina({{ page|add:-1 }})" {% if page <= 1 %}disabled{% endif %}>&lsaquo; Ant
    </button>
    <span>Página {{ page }} de {{ total_pages }}</span>
    <button type="button" onclick="irPagina({{ page|add:1 }})" {% if page >= total_pages %}disabled{% endif %}>Sig
        &rsaquo;
    </button>
    <button type="button" onclick="irPagina({{ total_pages }})" {% if page >= total_pages %}disabled{% endif %}>Último
        &raquo;
    </button>
</div>


<script>
    (() => {
        const $ = id => document.getElementById(id);

        const formBuscar = $('formBuscar');
        const tbody = $('tblBody');
        const pager = $('pager');
        const API_LISTAR = "{% url 'catalogoProductos:api_listar' %}";
        const buildDetailUrl = id => "{% url 'vistaProducto:detalle_producto' 0 %}".replace("0/", `${id}/`);
        const buildImgUrl = id => "{% url 'catalogoProductos:api_imagen' 0 %}".replace("0/", `${id}/`);

        const qFromForm = () => {
            const q = new URLSearchParams(new FormData(formBuscar));
            [...q.keys()].forEach(k => {
                if (!q.get(k)?.trim()) q.delete(k);
            });
            return q;
        };

        async function buscar(page = 1) {
            const q = qFromForm();
            q.set('page', page);
            try {
                const r = await fetch(`${API_LISTAR}?${q}`);
                const resp = await r.json();
                if (!resp.ok) return alert('Error al listar');
                renderTabla(resp.rows);
                renderPaginador(resp.page, resp.total_pages);
            } catch {
                alert('No se pudo obtener la lista');
            }
        }

        function renderTabla(rows) {
            if (!rows?.length) {
                tbody.innerHTML = `<div>Sin resultados</div>`;
                return;
            }
            tbody.innerHTML = rows.map(p => `
      <li>
        ${p.imagen_1_id ? `<img src="${buildImgUrl(p.imagen_1_id)}" alt="Imagen de ${p.nombre}">` : `<span>Sin imagen</span>`}
        <div>Precio: ${p.precio ?? '-'}</div>
        <div><a href="${buildDetailUrl(p.id)}"><strong>${p.nombre}</strong></a></div>
        <div>Autor: ${p.autor || '-'}</div>
        <div>Calificación: ${p.calificacion_promedio ?? '-'}</div>
        <div>${p.compras ?? 0} compras</div>
      </li>
    `).join('');
        }

        function renderPaginador(page, total) {
            const b = (label, target, disabled) =>
                `<button type="button" onclick="irPagina(${target})" ${disabled ? 'disabled' : ''}>${label}</button>`;

            pager.innerHTML = [
                b('&laquo; Primero', 1, page <= 1),
                b('&lsaquo; Ant', page - 1, page <= 1),
                `<span>Página ${page} de ${total}</span>`,
                b('Sig &rsaquo;', page + 1, page >= total),
                b('Último &raquo;', total, page >= total)
            ].join('');
        }

        window.irPagina = p => buscar(Math.max(1, p));

        formBuscar.addEventListener('submit', e => {
            e.preventDefault();
            buscar(1);
        });

        // carga inicial
        buscar(1);
    })();
</script>
</body>

</html>

